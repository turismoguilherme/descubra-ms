/**
 * üîç GUAT√Å REAL WEB SEARCH SERVICE
 * Sistema de pesquisa web REAL para o Guat√°
 * Integra Google Custom Search API + SerpAPI + APIs de turismo
 */

export interface WebSearchResult {
  title: string;
  snippet: string;
  url: string;
  source: string;
  confidence: number;
  timestamp: Date;
}

export interface TourismData {
  hotels?: Hotel[];
  events?: Event[];
  restaurants?: Restaurant[];
  weather?: Weather;
  attractions?: Attraction[];
}

export interface Hotel {
  name: string;
  address: string;
  price: string;
  rating: number;
  distance: string;
  contact: string;
  amenities: string[];
  source: string;
}

export interface Event {
  name: string;
  date: string;
  location: string;
  description: string;
  price: string;
  source: string;
}

export interface Restaurant {
  name: string;
  cuisine: string;
  rating: number;
  address: string;
  priceRange: string;
  specialties: string[];
  source: string;
}

export interface Weather {
  temperature: number;
  condition: string;
  humidity: number;
  forecast: string[];
  source: string;
}

export interface Attraction {
  name: string;
  type: string;
  rating: number;
  description: string;
  location: string;
  price: string;
  source: string;
}

export interface RealWebSearchQuery {
  question: string;
  location?: string;
  category?: 'hotels' | 'events' | 'restaurants' | 'attractions' | 'general';
  maxResults?: number;
}

export interface RealWebSearchResponse {
  results: WebSearchResult[];
  tourismData: TourismData;
  confidence: number;
  sources: string[];
  processingTime: number;
  usedRealSearch: boolean;
  searchMethod: 'google' | 'serpapi' | 'tourism_apis' | 'hybrid';
}

class GuataRealWebSearchService {
  private googleApiKey: string;
  private googleEngineId: string;
  private serpApiKey: string;
  private isConfigured: boolean = false;

  constructor() {
    this.googleApiKey = import.meta.env.VITE_GOOGLE_SEARCH_API_KEY || '';
    this.googleEngineId = import.meta.env.VITE_GOOGLE_SEARCH_ENGINE_ID || '';
    this.serpApiKey = import.meta.env.VITE_SERPAPI_KEY || '';
    
    this.isConfigured = !!(this.googleApiKey && this.googleEngineId);
    console.log('üîç Guat√° Real Web Search:', this.isConfigured ? 'CONFIGURADO' : 'N√ÉO CONFIGURADO');
    console.log('üîë Google API Key:', this.googleApiKey ? 'PRESENTE' : 'AUSENTE');
    console.log('üîë Google Engine ID:', this.googleEngineId ? 'PRESENTE' : 'AUSENTE');
  }

  /**
   * Pesquisa web REAL usando Google Custom Search API
   */
  private async searchWithGoogle(query: string, maxResults: number = 5): Promise<WebSearchResult[]> {
    if (!this.isConfigured) {
      console.log('‚ö†Ô∏è Google Custom Search n√£o configurado');
      return [];
    }

    try {
      const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${this.googleApiKey}&cx=${this.googleEngineId}&q=${encodeURIComponent(query)}&num=${maxResults}`;
      
      console.log('üîç Fazendo pesquisa REAL no Google...');
      const response = await fetch(searchUrl);
      
      if (!response.ok) {
        throw new Error(`Google Search API error: ${response.status}`);
      }

      const data = await response.json();
      const results: WebSearchResult[] = [];

      if (data.items) {
        data.items.forEach((item: any, index: number) => {
          results.push({
            title: item.title || '',
            snippet: item.snippet || '',
            url: item.link || '',
            source: 'google_search',
            confidence: 0.9 - (index * 0.1),
            timestamp: new Date()
          });
        });
      }

      console.log(`‚úÖ Google Search: ${results.length} resultados encontrados`);
      return results;

    } catch (error) {
      console.error('‚ùå Erro na Google Search API:', error);
      return [];
    }
  }

  /**
   * Pesquisa usando SerpAPI (alternativa premium)
   */
  private async searchWithSerpAPI(query: string, maxResults: number = 5): Promise<WebSearchResult[]> {
    if (!this.serpApiKey) {
      console.log('‚ö†Ô∏è SerpAPI n√£o configurado');
      return [];
    }

    try {
      const serpUrl = `https://serpapi.com/search?api_key=${this.serpApiKey}&q=${encodeURIComponent(query)}&num=${maxResults}`;
      
      console.log('üîç Fazendo pesquisa REAL no SerpAPI...');
      const response = await fetch(serpUrl);
      
      if (!response.ok) {
        throw new Error(`SerpAPI error: ${response.status}`);
      }

      const data = await response.json();
      const results: WebSearchResult[] = [];

      if (data.organic_results) {
        data.organic_results.forEach((item: any, index: number) => {
          results.push({
            title: item.title || '',
            snippet: item.snippet || '',
            url: item.link || '',
            source: 'serpapi',
            confidence: 0.95 - (index * 0.05),
            timestamp: new Date()
          });
        });
      }

      console.log(`‚úÖ SerpAPI: ${results.length} resultados encontrados`);
      return results;

    } catch (error) {
      console.error('‚ùå Erro na SerpAPI:', error);
      return [];
    }
  }

  /**
   * Busca dados espec√≠ficos de turismo
   */
  private async searchTourismData(query: RealWebSearchQuery): Promise<TourismData> {
    const tourismData: TourismData = {};

    try {
      // Buscar hot√©is se a pergunta for sobre hospedagem
      if (query.category === 'hotels' || query.question.toLowerCase().includes('hotel') || query.question.toLowerCase().includes('hospedagem')) {
        tourismData.hotels = await this.searchHotels(query.location || 'Mato Grosso do Sul');
      }

      // Buscar eventos se a pergunta for sobre eventos
      if (query.category === 'events' || query.question.toLowerCase().includes('evento') || query.question.toLowerCase().includes('festa')) {
        tourismData.events = await this.searchEvents(query.location || 'Mato Grosso do Sul');
      }

      // Buscar restaurantes se a pergunta for sobre comida
      if (query.category === 'restaurants' || query.question.toLowerCase().includes('restaurante') || query.question.toLowerCase().includes('comida')) {
        tourismData.restaurants = await this.searchRestaurants(query.location || 'Mato Grosso do Sul');
      }

      // Buscar clima se a pergunta for sobre tempo
      if (query.question.toLowerCase().includes('clima') || query.question.toLowerCase().includes('tempo')) {
        tourismData.weather = await this.searchWeather(query.location || 'Mato Grosso do Sul');
      }

    } catch (error) {
      console.error('‚ùå Erro ao buscar dados de turismo:', error);
    }

    return tourismData;
  }

  /**
   * Busca hot√©is usando APIs de turismo
   */
  private async searchHotels(location: string): Promise<Hotel[]> {
    // N√ÉO retornar dados simulados - apenas dados reais
    console.log('üè® Buscando hot√©is reais para:', location);
    return []; // Retornar vazio at√© ter APIs reais
  }

  /**
   * Busca eventos usando APIs de eventos
   */
  private async searchEvents(location: string): Promise<Event[]> {
    // N√ÉO retornar dados simulados - apenas dados reais
    console.log('üéâ Buscando eventos reais para:', location);
    return []; // Retornar vazio at√© ter APIs reais
  }

  /**
   * Busca restaurantes usando APIs de gastronomia
   */
  private async searchRestaurants(location: string): Promise<Restaurant[]> {
    // N√ÉO retornar dados simulados - apenas dados reais
    console.log('üçΩÔ∏è Buscando restaurantes reais para:', location);
    return []; // Retornar vazio at√© ter APIs reais
  }

  /**
   * Busca dados de clima
   */
  private async searchWeather(location: string): Promise<Weather> {
    // N√ÉO retornar dados simulados - apenas dados reais
    console.log('üå§Ô∏è Buscando dados de clima reais para:', location);
    return {
      temperature: 0,
      condition: "Dados n√£o dispon√≠veis",
      humidity: 0,
      forecast: [],
      source: "no_data"
    };
  }

  /**
   * M√©todo principal de pesquisa web real
   */
  async searchRealTime(query: RealWebSearchQuery): Promise<RealWebSearchResponse> {
    const startTime = Date.now();
    console.log('üîç Guat√° Real Web Search: Iniciando pesquisa...');
    console.log('üìù Query:', query.question);
    console.log('üìç Localiza√ß√£o:', query.location || 'Mato Grosso do Sul');
    console.log('üè∑Ô∏è Categoria:', query.category || 'geral');

    let results: WebSearchResult[] = [];
    let searchMethod: 'google' | 'serpapi' | 'tourism_apis' | 'hybrid' = 'tourism_apis';
    let usedRealSearch = false;

    try {
      // 1. Tentar Google Custom Search primeiro
      if (this.isConfigured) {
        console.log('üîç Tentando Google Custom Search...');
        const googleResults = await this.searchWithGoogle(query.question, query.maxResults || 5);
        if (googleResults.length > 0) {
          results = googleResults;
          searchMethod = 'google';
          usedRealSearch = true;
          console.log('‚úÖ Google Search bem-sucedido!');
        }
      }

      // 2. Se Google falhar, tentar SerpAPI
      if (results.length === 0 && this.serpApiKey) {
        console.log('üîç Tentando SerpAPI...');
        const serpResults = await this.searchWithSerpAPI(query.question, query.maxResults || 5);
        if (serpResults.length > 0) {
          results = serpResults;
          searchMethod = 'serpapi';
          usedRealSearch = true;
          console.log('‚úÖ SerpAPI bem-sucedido!');
        }
      }

      // 3. Buscar dados espec√≠ficos de turismo
      console.log('üè® Buscando dados espec√≠ficos de turismo...');
      const tourismData = await this.searchTourismData(query);

      // 4. Se nenhuma pesquisa web funcionou, usar dados locais
      if (results.length === 0) {
        console.log('‚ö†Ô∏è Nenhuma pesquisa web funcionou, usando dados locais...');
        results = this.generateLocalSearchResults(query.question);
        searchMethod = 'tourism_apis';
        usedRealSearch = false;
      }

      const processingTime = Date.now() - startTime;
      console.log(`‚úÖ Guat√° Real Web Search: Conclu√≠do em ${processingTime}ms`);
      console.log(`üìä Resultados: ${results.length}`);
      console.log(`üåê M√©todo: ${searchMethod}`);
      console.log(`üîç Pesquisa real: ${usedRealSearch}`);

      return {
        results,
        tourismData,
        confidence: usedRealSearch ? 0.9 : 0.7,
        sources: results.map(r => r.source),
        processingTime,
        usedRealSearch,
        searchMethod
      };

    } catch (error) {
      console.error('‚ùå Erro no Guat√° Real Web Search:', error);
      
      return {
        results: this.generateLocalSearchResults(query.question),
        tourismData: {},
        confidence: 0.5,
        sources: ['local_fallback'],
        processingTime: Date.now() - startTime,
        usedRealSearch: false,
        searchMethod: 'tourism_apis'
      };
    }
  }

  /**
   * Gera resultados de busca locais como fallback
   */
  private generateLocalSearchResults(question: string): WebSearchResult[] {
    const lowerQuestion = question.toLowerCase();
    
    // Gerar resultados inteligentes baseados na pergunta
    const results: WebSearchResult[] = [];
    
    // Detectar tipo de pergunta e gerar resposta espec√≠fica
    if (lowerQuestion.includes('bonito')) {
      results.push({
        title: "Bonito MS - Capital do Ecoturismo",
        snippet: "Bonito √© conhecido mundialmente por suas √°guas cristalinas, grutas, cachoeiras e flutua√ß√£o. Principais atrativos: Rio da Prata, Gruta do Lago Azul, Buraco das Araras, Aqu√°rio Natural.",
        url: "https://descubrams.com.br/bonito",
        source: "local_knowledge",
        confidence: 0.9,
        timestamp: new Date()
      });
    }
    
    if (lowerQuestion.includes('pantanal')) {
      results.push({
        title: "Pantanal - Maior √Årea √ömida do Mundo",
        snippet: "O Pantanal sul-mato-grossense √© um santu√°rio ecol√≥gico √∫nico, habitat de jacar√©s, capivaras, ariranhas e centenas de esp√©cies de aves. Melhor √©poca: maio a outubro.",
        url: "https://descubrams.com.br/pantanal",
        source: "local_knowledge",
        confidence: 0.9,
        timestamp: new Date()
      });
    }
    
    if (lowerQuestion.includes('campo grande')) {
      results.push({
        title: "Campo Grande - Capital de Mato Grosso do Sul",
        snippet: "Campo Grande, a 'Cidade Morena', oferece o Bioparque Pantanal (maior aqu√°rio de √°gua doce do mundo), Parque das Na√ß√µes Ind√≠genas, Feira Central e rica gastronomia regional.",
        url: "https://descubrams.com.br/campo-grande",
        source: "local_knowledge",
        confidence: 0.9,
        timestamp: new Date()
      });
    }
    
    if (lowerQuestion.includes('hotel') || lowerQuestion.includes('hospedagem')) {
      results.push({
        title: "Hospedagem em Mato Grosso do Sul",
        snippet: "MS oferece diversas op√ß√µes de hospedagem: hot√©is urbanos em Campo Grande, pousadas ecol√≥gicas em Bonito, fazendas no Pantanal e hospedagem rural em outras cidades.",
        url: "https://descubrams.com.br/hospedagem",
        source: "local_knowledge",
        confidence: 0.8,
        timestamp: new Date()
      });
    }
    
    if (lowerQuestion.includes('comida') || lowerQuestion.includes('gastronomia') || lowerQuestion.includes('restaurante')) {
      results.push({
        title: "Gastronomia de Mato Grosso do Sul",
        snippet: "A culin√°ria sul-mato-grossense √© rica e diversificada: sob√°, chipa, espetinho, churrasco pantaneiro, sopa paraguaia, terer√© e pratos com influ√™ncias ind√≠genas e paraguaias.",
        url: "https://descubrams.com.br/gastronomia",
        source: "local_knowledge",
        confidence: 0.8,
        timestamp: new Date()
      });
    }
    
    // Se n√£o encontrou resultados espec√≠ficos, retornar informa√ß√£o geral
    if (results.length === 0) {
      results.push({
        title: "Mato Grosso do Sul - Portal Oficial de Turismo",
        snippet: "Descubra as maravilhas de MS: Pantanal, Bonito, Campo Grande e muito mais. Turismo, cultura e aventura.",
        url: "https://descubrams.com.br",
        source: "local_knowledge",
        confidence: 0.7,
        timestamp: new Date()
      });
    }
    
    return results;
  }
}

// Exportar inst√¢ncia √∫nica
export const guataRealWebSearchService = new GuataRealWebSearchService();
